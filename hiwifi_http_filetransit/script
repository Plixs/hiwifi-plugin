#!/bin/sh

# TODO：none

conf_path="/etc/lighttpd/lighttpd.conf"
auth_path="/etc/lighttpd/lighttpd.user"
setting_path="/etc/market/http_filetransit.conf"

install()
{
    cp -r etc /
    cp -r usr /
    cp http_filetransit.conf $setting_path
    ln -s /usr/lib/libpcre.so /usr/lib/libpcre.so.1 # will not remove when uninstalling 卸载时不会移除此文件
    configure
    chmod +x /usr/sbin/lighttpd
    chmod +x /etc/init.d/lighttpd
    start
    return 0
}

uninstall()
{
    stop
    rm /etc/init.d/lighttpd
    rm -rf /etc/lighttpd
    rm -rf /usr/lib/lighttpd
    rm /usr/sbin/lighttpd
    rm $setting_path
    return 0
}

start()
{
    /etc/init.d/lighttpd start
    /etc/init.d/lighttpd enable
}

stop()
{
    /etc/init.d/lighttpd stop
    /etc/init.d/lighttpd disable
}

status()
{
    . $setting_path
    if [ $(ps|grep 'lighttpd'|wc -l) -ge "2" ]; then
        status="running"
    else
        status="stopped"
    fi
    lan_ip=$(ifconfig br-lan|grep 'inet addr'|awk '{print $2}'|tr -d 'addr:')
    echo '{ "status" : "'$status'", "msg" : "<a href=\"http://'$lan_ip':'$port'\" target=\"_blank\">http://'$lan_ip':'$port'</a>" }'
}

reconfigure()
{
    stop
    cp http_filetransit.conf $setting_path
    configure
    start
    return 0
}

configure(){
    . $setting_path
    sed -i "s/server.port = [0-9]*/server.port = $port/g" $conf_path
    if [ $auth == '1' ]; then
        echo $username:$password > $auth_path
        sed -i "s/\"require\" => \"user=.*\"/\"require\" => \"user=$username\"/g" $conf_path
        sed -i "s/.*\"mod_auth\".*/        \"mod_auth\"/g" $conf_path
    else
        sed -i "s/.*\"mod_auth\".*/#        \"mod_auth\"/g" $conf_path
    fi
}